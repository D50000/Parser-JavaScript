/* eslint-disable no-console */
const request = require('request');
const fs = require('fs');
const path = require('path');
console.log('Updating browser ids...');
const filepath = path.join(__dirname, '../data/id-android.js');
const fileStream = fs.createWriteStream(filepath);

request('https://api.whichbrowser.net/resources/browser-ids.json', (err, response = {}) => {
  if (err) {
    return;
  }
  const result = JSON.parse(response.body);
  fileStream.write('/* This file is automatically generated, do not edit manually! */\n\n');
  fileStream.write('exports.ANDROID_BROWSERS = {\n');
  result.forEach((val) => fileStream.write(`  '${val.browserId}': ${deviceString(val.browserName)},\n`), null);
  fileStream.write('};\n\n');
  fileStream.write('/* This file is automatically generated, do not edit manually! */\n');
  fileStream.end();
  console.log(`Browser ids update complete with ${result.length} entries...`);
});

/**
 * Escapes \ and ' inside string
 *
 * @param {string|null} str
 *
 * @return {string|null}
 */
function deviceString(str) {
  if (!str) {
    return null;
  }
  return `'${(str + '').replace(/[\\']/g, '\\$&').replace(/\u0000/g, '\\0')}'`;
}
